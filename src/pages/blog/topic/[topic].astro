---
import BaseLayout from '@/layouts/BaseLayout.astro';
import BackLink from '@/components/BackLink.astro';
import PostCard from '@/components/PostCard.astro';
import type { CollectionEntry } from 'astro:content';
import { topics } from '@/data/topics';
import { getPostCardProps, getPostsByTopic, getPublishedBlogPosts } from '@/utils/blog';

export async function getStaticPaths() {
  const allPosts = await getPublishedBlogPosts();

  return topics.map((topic) => {
    const filteredPosts = getPostsByTopic(allPosts, topic.slug);

    return {
      params: { topic: topic.slug },
      props: { topic, posts: filteredPosts },
    };
  });
}

const { topic, posts } = Astro.props as {
  topic: (typeof topics)[number];
  posts: CollectionEntry<'blog'>[];
};
---

<BaseLayout title={`${topic.title} — Blog — Bhavya Kandhari`} description={topic.description}>
  <div class="mx-auto max-w-2xl px-5 pt-16 sm:pt-24">
    <header class="mb-12">
      <BackLink href="/blog" label="All topics" />

      <h1 class="font-display text-3xl sm:text-4xl leading-tight tracking-tight text-text">
        {topic.title}
      </h1>
      <p class="mt-3 text-base text-text-secondary">
        {topic.description}
      </p>
      <p class="mt-1.5 font-mono text-xs text-text-muted tracking-wider">
        {posts.length} {posts.length === 1 ? 'post' : 'posts'}
      </p>
    </header>

    {posts.length > 0 ? (
      <>
        <h2 class="sr-only">Posts in {topic.title}</h2>

        <ul class="list-none p-0 m-0">
          {posts.map((post) => (
            <PostCard {...getPostCardProps(post)} />
          ))}
        </ul>
      </>
    ) : (
      <p class="text-text-muted text-sm">
        No posts in this topic yet. Check back soon.
      </p>
    )}
  </div>
</BaseLayout>
